generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =====================
// ENUMS
// =====================

// Notification types enum
enum NotificationType {
  LIKE
  REPLY
  FOLLOW
  MENTION
  REPOST
}

// Post visibility enum
enum PostVisibility {
  PUBLIC
  FOLLOWERS
  PRIVATE
}

// Media type enum
enum MediaType {
  IMAGE
  VIDEO
  GIF
}

// =====================
// USER & AUTH
// =====================

// Users table
model User {
  id              String         @id @default(uuid())
  firstName       String         @map("first_name")
  lastName        String?        @map("last_name")
  username        String         @unique
  profileImageUrl String?        @map("profile_image_url")
  email           String         @unique
  password        String
  salt            String
  is_verified     Boolean        @default(false)
  is_private      Boolean        @default(false)
  status          String?
  bio             String?
  website         String?
  location        String?
  dob             DateTime?
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Auth Relations
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]

  // Social Relations
  followers    Follow[] @relation("following")
  following    Follow[] @relation("follower")
  blockedUsers Block[]  @relation("blocker")
  blockedBy    Block[]  @relation("blocked")

  // Notification Relations
  notificationsReceived Notification[] @relation("user")
  notificationsSent     Notification[] @relation("actor")

  // Post Relations
  posts       Post[]
  likes       PostLike[]
  bookmarks   Bookmark[]
  mentionedIn PostMention[] @relation("mentionedUser")

  @@map("users")
}

// Refresh tokens table
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("refresh_tokens")
}

// Password reset tokens table
model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}

// =====================
// SOCIAL RELATIONSHIPS
// =====================

// Follow relationship
model Follow {
  id          String   @id @default(uuid())
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  follower    User     @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("following", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([followerId, followingId])
  @@map("follows")
}

// Block relationship
model Block {
  id        String   @id @default(uuid())
  blockerId String   @map("blocker_id")
  blockedId String   @map("blocked_id")
  blocker   User     @relation("blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([blockerId, blockedId])
  @@map("blocks")
}

// Notifications table
model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  actorId   String           @map("actor_id")
  type      NotificationType
  entityId  String?          @map("entity_id")
  isRead    Boolean          @default(false) @map("is_read")
  user      User             @relation("user", fields: [userId], references: [id], onDelete: Cascade)
  actor     User             @relation("actor", fields: [actorId], references: [id], onDelete: Cascade)
  createdAt DateTime         @default(now()) @map("created_at")

  @@map("notifications")
}

// =====================
// POSTS / THREADS
// =====================

// Posts table (main content)
model Post {
  id           String         @id @default(uuid())
  content      String?        @db.Text
  visibility   PostVisibility @default(PUBLIC)
  authorId     String         @map("author_id")
  author       User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parentPostId String?        @map("parent_post_id")
  parentPost   Post?          @relation("PostReplies", fields: [parentPostId], references: [id], onDelete: SetNull)
  replies      Post[]         @relation("PostReplies")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  // Post Relations
  likes     PostLike[]
  bookmarks Bookmark[]
  media     PostMedia[]
  hashtags  PostHashtag[]
  mentions  PostMention[]

  @@index([authorId])
  @@index([parentPostId])
  @@index([createdAt])
  @@map("posts")
}

// Post media attachments
model PostMedia {
  id        String    @id @default(uuid())
  postId    String    @map("post_id")
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  mediaType MediaType
  mediaUrl  String    @map("media_url")
  position  Int       @default(0)
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("post_media")
}

// =====================
// LIKES & BOOKMARKS
// =====================

// Post likes (user favorites)
model PostLike {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  postId    String   @map("post_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, postId])
  @@index([postId])
  @@map("post_likes")
}

// Bookmarks (saved posts)
model Bookmark {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  postId    String   @map("post_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, postId])
  @@index([userId])
  @@map("bookmarks")
}

// =====================
// HASHTAGS
// =====================

// Hashtags table
model Hashtag {
  id         String        @id @default(uuid())
  tag        String        @unique
  usageCount Int           @default(0) @map("usage_count")
  posts      PostHashtag[]
  createdAt  DateTime      @default(now()) @map("created_at")

  @@map("hashtags")
}

// Post-Hashtag join table
model PostHashtag {
  id        String  @id @default(uuid())
  postId    String  @map("post_id")
  hashtagId String  @map("hashtag_id")
  post      Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  hashtag   Hashtag @relation(fields: [hashtagId], references: [id], onDelete: Cascade)

  @@unique([postId, hashtagId])
  @@index([hashtagId])
  @@map("post_hashtags")
}

// =====================
// MENTIONS
// =====================

// Post mentions (@ mentions)
model PostMention {
  id              String @id @default(uuid())
  postId          String @map("post_id")
  mentionedUserId String @map("mentioned_user_id")
  post            Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  mentionedUser   User   @relation("mentionedUser", fields: [mentionedUserId], references: [id], onDelete: Cascade)

  @@unique([postId, mentionedUserId])
  @@map("post_mentions")
}
